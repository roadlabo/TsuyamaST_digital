# IPCamra_config

## 0. このMDの目的（録画・監視・AI解析の3目的）
本書は、IPカメラを**複数台で安定運用**するための設定基準を定義する。対象目的は以下の3つとする。

- 録画サーバでの**複数カメラ録画**
- 監視PC/モニタでの**複数カメラ常時監視**
- AI解析サーバでの**RTSP/ONVIF入力**

本書は「推奨 / 理由 / 注意」をセットで示す。閉域LANまたはVPN運用を前提とし、インターネット公開は前提にしない。

## 1. 基本方針（カメラは“映像を出すだけ”、録画とAIはサーバ側）
- **推奨**：カメラは「映像配信（RTSP/ONVIF）専用」にする。
  - **理由**：役割分離で障害切り分けが容易になり、台数増加時も安定しやすい。
  - **注意**：録画・解析ロジックをカメラ側イベント依存にしない。
- **推奨**：録画管理・保存期間管理は録画/VMSサーバ側で実施する。
  - **理由**：台数増加時の運用統一とバックアップ管理が容易になる。
  - **注意**：カメラ個別SD保存は補助用途に限定する。
- **推奨**：AI解析はサブストリームを入力にする。
  - **理由**：CPU/GPUとネットワーク負荷を抑えつつ、多台数同時処理しやすい。
  - **注意**：解析精度が不足する場合のみ段階的にビットレート/解像度を上げる。

## 2. ネットワーク設定（ローカルネットワーク／デバイスポート）

### 2.1 ローカルネットワーク
| 項目 | 推奨設定 | 理由 | 注意 |
|---|---|---|---|
| IPアドレス | 固定IP（例: `192.168.1.101` 〜 `192.168.1.199`） | 録画サーバ/AI側の接続先が不変になり障害を減らせる | DHCP任せにしない |
| サブネットマスク | `255.255.255.0`（環境設計に従う） | 同一セグメントで疎通を安定化できる | 既存ネットワーク設計を優先 |
| デフォルトゲートウェイ | 例: `192.168.1.1` | NTP参照や管理経路の整合が取れる | 閉域でも未設定放置は避ける |
| 優先DNS/代替DNS | 例: `192.168.1.1` / `8.8.8.8`（社内規定優先） | NTP/FQDN利用時の名前解決失敗を防ぐ | 社内ポリシー外DNSは使わない |

### 2.2 デバイスポート
| 項目 | 推奨設定 | 理由 | 注意 |
|---|---|---|---|
| HTTPポート | 既定値（通常 `80`）または管理方針に合わせて固定 | Web管理画面の接続先を標準化できる | 外部公開しない |
| RTSPポート | `554`（既定） | クライアント互換性が高い | 他機器と競合時のみ変更 |
| ONVIFポート | 既定値（機種仕様準拠） | VMS/CMSの自動探索互換性を維持できる | 根拠なく変更しない |

## 3. 時刻設定（NTP推奨、録画・AIログ整合のため）
| 項目 | 推奨設定 | 理由 | 注意 |
|---|---|---|---|
| 時刻同期方式 | NTPをON | 録画時刻とAIイベント時刻の突合性を確保できる | 手動時刻合わせ運用は禁止 |
| NTPサーバ | 社内NTPまたは信頼できるNTP | 全カメラで時刻基準を統一できる | カメラごとに異なるNTPを設定しない |
| タイムゾーン | `Asia/Tokyo (UTC+09:00)` | 表示時刻の解釈ミスを防げる | サマータイム設定を誤らない |

## 4. ビデオ設定（メイン＝録画、サブ＝AI解析）
| ストリーム | 推奨設定（目安） | 理由 | 注意 |
|---|---|---|---|
| メインストリーム（録画） | 10〜15fps、必要解像度（例: 1080p） | 証跡品質と容量のバランスが良い | 高fps固定は容量/帯域を圧迫 |
| サブストリーム（AI解析） | 5〜10fps、低〜中解像度（例: 640x360〜1280x720） | 多台数AI処理を安定化できる | 精度不足時のみ段階的に引き上げる |
| 圧縮方式 | H.264または環境標準 | デコーダ互換性が高くトラブルが少ない | サーバ側対応なしのコーデックを選ばない |

- **注記**：fps/解像度/ビットレートの具体項目がこの画面にない場合は、**ストリーム設定画面**で設定する。

## 5. OSD（必要ならON。AI解析に邪魔ならOFF）
- **推奨**：録画証跡を重視するカメラはOSD（日時/カメラ名）をONにする。
  - **理由**：単体映像でも時刻・設置識別が確認しやすい。
  - **注意**：文字位置が対象物に重なると可読性が落ちる。
- **推奨**：AI解析用途で検出領域に文字が重なる場合はOSDをOFFまたは位置変更する。
  - **理由**：誤検出や認識率低下を防げる。
  - **注意**：AI用と録画用でストリームを分けて判断する。

## 6. ネットワークサービス（画面項目に沿った推奨）
| 項目 | 推奨 | 理由 | 注意 |
|---|---|---|---|
| 802.1X | 原則OFF | 認証基盤がない状態で有効化すると接続不能化のリスクが高い | 導入する場合は運用要件・検証を先に実施 |
| DDNS | OFF | 閉域LAN/VPN運用では不要、外部公開リスクを減らせる | ルータ越え運用を前提にしない |
| PPPoE | OFF | カメラが直接ISP接続する構成を排除できる | 企業LANでは通常不要 |
| ポートマッピング | OFF | 不要な外部到達経路を遮断できる | ルータのポート開放を行わない |
| IPフィルター | 必要時のみON（管理PCのみ許可） | 誤接続・不正アクセスの保険になる | 許可リスト更新漏れに注意 |
| CGIアラームサービスセンター | OFF | 本システムで未使用の通知先を減らせる | 将来連携時のみ再評価 |
| SNMP | OFF（現時点） | 監視基盤未使用なら攻撃面を減らせる | 将来監視導入時のみONを検討 |
| QoS | 触らない（既定） | 誤設定で全体通信品質を悪化させるため | 必要性が明確な時のみネットワーク担当が設定 |
| プラットフォームアクセス | OFF | クラウド連携不要、外部依存を排除できる | ベンダークラウドを安易に有効化しない |
| マルチキャスト | 原則触らない（既定） | スイッチ設計不整合時にトラフィック拡散を招く | 必要時のみネットワーク設計とセットで有効化 |

## 7. ユーザー管理（最重要）
- **推奨**：`admin`（SuperAdmin）は保管用アカウントとし、日常運用で使わない。
  - **理由**：誤操作と資格情報漏えい時の影響を最小化できる。
  - **注意**：初期パスワードのまま運用しない。
- **推奨**：用途別ユーザーを分離する。
  - **理由**：権限分離で監査性と安全性が上がる。
  - **注意**：同一IDを録画とAIで使い回さない。

| ユーザー名 | 用途 | 推奨権限 | プロトコル |
|---|---|---|---|
| admin | 緊急保守・設定変更のみ | SuperAdmin | 必要時のみログイン |
| recorder | 録画/VMS接続 | 映像閲覧・配信に必要な最小権限 | ONVIF + RTSP |
| ai | AI解析入力専用 | 映像閲覧の最小権限 | RTSPのみ |

- パスワード管理方針
  - 使い回し禁止。
  - 20文字以上を推奨（英大文字/英小文字/数字/記号を混在）。
  - 保管はパスワードマネージャまたは管理台帳で行い、平文メモを残さない。

## 8. プロトコル（ONVIF/RTSP）
- **ONVIF**：ONにする。
  - **理由**：録画サーバ/CMSの自動探索・標準連携がしやすい。
  - **注意**：不要ユーザーにONVIF権限を与えない。
- **RTSP**：ONにする。
  - **理由**：VMS/AIでの直接ストリーム取得に必要。
  - **注意**：平文プロトコルのため閉域LAN/VPN内でのみ使用する。

### RTSP URL書式と例
- 書式（画面の記載形式に合わせる）：
  - `rtsp://<user>:<password>@<camera_ip>:<rtsp_port>/Streaming/Channels/<channel_id>`
- 具体例：
  - メイン（高画質）: `rtsp://ai:******@192.168.1.101:554/Streaming/Channels/101`
  - サブ（AI向け）: `rtsp://ai:******@192.168.1.101:554/Streaming/Channels/102`

- **ONVIF UUID**：機器登録時に要求される場合があるため控える。
- **CMS設定**：ONVIFをONにし、他プロトコルは互換性要件がない限り基本OFFとする。

## 9. メンテナンス
| 項目 | 推奨 | 理由 | 注意 |
|---|---|---|---|
| 自動再起動 | OFF | 勝手な再起動で映像欠損すると原因追跡が難しくなる | 障害対策は計画停止で実施 |
| 設定バックアップ | 定期的にローカル保存 | 障害時の復旧時間を短縮できる | FW更新前後は必ず取得 |
| 設定復元 | 保守手順書に沿って実施 | 復旧品質を標準化できる | 機種違いファイルを適用しない |

- バックアップ/復元手順（要点）
  1. 管理画面にログインする。
  2. メンテナンス画面で「設定エクスポート」を実行し、ローカル保存する。
  3. 復元時は対象機器・FW版を確認して「設定インポート」を実行する。
  4. 復元後に時刻同期・RTSP・ONVIF接続を再確認する。

## 10. 動作確認チェックリスト
- 管理PCからブラウザ表示OK（HTTP/HTTPSで管理画面にアクセス可能）。
- `ping` 疎通OK（遅延・パケットロスが許容範囲）。
- RTSP再生OK（VLC / ffplayで映像確認）。
  - 例: `ffplay "rtsp://ai:******@192.168.1.101:554/Streaming/Channels/102"`
- ONVIF探索OK（ONVIF Device Manager等で検出・接続確認）。
- 録画サーバで複数台登録OK（同時録画と保持期間設定を確認）。
- AI解析PCでサブストリーム取得OK（想定fpsで連続取得できる）。

---

## やってはいけない設定（禁止）
- DDNSを有効化して外部公開前提にする。
- ルータでポート開放（ポートマッピング）を行う。
- `admin` アカウントを日常運用に使い続ける。
- 録画用とAI用で同一ユーザー/同一パスワードを使い回す。
- QoS/802.1X/マルチキャストを要件不明のまま有効化する。
